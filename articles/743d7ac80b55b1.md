---
title: "Zigã§WASM"
emoji: "ğŸªš"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Zig", "WASM"]
published: true
---
# æœ¬è¨˜äº‹ã¯

[ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¤ ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼1æ—¥ç›®ã®è¨˜äº‹](https://qiita.com/advent-calendar/2024/systemi24)ã§ã™ã€‚

ã™ã¿ã¾ã›ã‚“ã€1æ—¥ç›®ã‹ã‚‰ã‚®ãƒªã‚®ãƒªã«ãªã£ã¦ã„ã¾ã™ã€‚

# Zigã§WASMã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹

Zigè¨€èªã¯ã€ã€Œå …ç‰¢ã€æœ€é©ã€ãŠã‚ˆã³å†åˆ©ç”¨å¯èƒ½ãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã™ã‚‹ãŸã‚ã®æ±ç”¨ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªãŠã‚ˆã³ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã€ã§ã™ã€‚ï¼ˆå…¬å¼ã‚ˆã‚Šå¼•ç”¨ï¼‰

æœ€è¿‘ã§ã¯ã€ŒBunã€ã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚ŒãŸã‚Šã—ã¦ã„ã¾ã™ã€‚

Zigã¯[LLVM](https://llvm.org/)ã‚’å†…åŒ…ã—ã¦ãŠã‚Šã€C/C++ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚‚ã§ãã¾ã™ã€‚

LLVMã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€WASMã‚’å‡ºåŠ›ã‚‚ã§ãã¾ã™ã€‚

ãã“ã§ã€ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚‚ã¡ã„ã¦WASMã‚’ãƒ“ãƒ«ãƒ‰ã—ã€JavaScriptã‹ã‚‰åˆ©ç”¨ã™ã‚‹ã€ã¨ã„ã†ã®ã‚’è©¦ã—ã¦ã¿ã‚ˆã†ã€ã¨ã—ã¾ã—ãŸã€‚

# tl;dr

* Zigã§WASMã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã¾ã—ãŸ

# ã•ãã£ã¨æ¤œç´¢ã—ãŸçµæœ

```sh
$ mkdir zig-wasm-sample
$ cd zig-wasm-sample
$ zig init
info: created build.zig
info: created build.zig.zon
info: created src/main.zig
info: created src/root.zig
info: see `zig build --help` for a menu of options
```

`main.zig`ã¯mainé–¢æ•°ãŒã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ãŒã€ä»Šå›ã¯ç½®ã„ã¦ãŠãã¾ã™ã€‚

`root.zig`ã®å†…å®¹ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã€‚

```zig
const std = @import("std");
const testing = std.testing;

export fn add(a: i32, b: i32) i32 {
    return a + b;
}

test "basic add functionality" {
    try testing.expect(add(3, 7) == 10);
}
```

ç°¡å˜ãªè¶³ã—ç®—ã‚’ã™ã‚‹é–¢æ•°ã¨ã€ãã‚Œã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ã“ã„ã¤ã‚’WASMã«ãƒ“ãƒ«ãƒ‰ã—ãŸã„ã€‚

æ¤œç´¢ã—ãŸçµæœã€Œ[Denoã‹ã‚‰Zigã§ä½œã£ãŸWasmã‚’ä½¿ã†](https://zenn.dev/itte/articles/dc7471ffc2f76f)ã€ã¨ã„ã†è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

ã“ã®è¨˜äº‹ã®æ®µéšã§Zigã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯`0.12.0`ã€‚ä¸€æ–¹2024/12æœˆç¾åœ¨ã®æœ€æ–°ã¯`0.13.0`ã€‚å½“è©²è¨˜äº‹ã«ã‚‚ã‚ã‚Šã¾ã™ãŒã€Zigã¯ã¾ã ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è‡³ã£ã¦ãŠã‚‰ãšã€ä»•æ§˜ãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«ã‚³ãƒ­ã‚³ãƒ­å¤‰ã‚ã‚Šã¾ã™ã€‚Bunã¯ã‚ˆãã“ã‚“ãªä¸­ã§é–‹ç™ºã§ãã¦ã„ã‚‹ã‚ˆãªã€‚ã€‚ã€‚

ã²ã¨ã¾ãšã€ãƒ“ãƒ«ãƒ‰ã‚’è©¦ã—ã¾ã™ã€‚

```sh
$ zig build-exe src/root.zig -target wasm32-freestanding -fno-entry -rdynamic --import-memory -O ReleaseSmall
$ ls
build.zig  build.zig.zon  root.wasm  root.wasm.o  src
```

wasmãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ãã¾ã—ãŸã€‚

ã“ã‚Œã‚’JavaScriptã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ã¿ã¾ã™ã€‚ã²ã¨ã¾ãšnode.jsã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

å…ˆç¨‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã€index.jsã‚’ä½œã‚Šã¾ã™ã€‚

```JavaScript
const fs = require('node:fs')
const memory = new WebAssembly.Memory({initial:20, maximum:100})
const wasm_module = new WebAssembly.Module(fs.readFileSync('root.wasm'))
const instance = new WebAssembly.Instance(wasm_module, { env: { memory } })
const add = instance.exports.add
const result = add(3, 7)
console.log(result)
```

å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```sh
$ node index.js
10
# bunã§ã‚‚ã‚„ã£ã¦ã¿ã‚‹
$ bun run index.js
10
```

ç°¡å˜ã«ã§ãã¾ã—ãŸã­ã€‚

ã¨ã¯ã„ãˆã“ã‚Œã ã‘ã§ã¯å…ˆè¡Œè¨˜äº‹ã‚’è¿½ã„ã‹ã‘ãŸã ã‘ã«éãã¾ã›ã‚“ã®ã§ã€ãªã«ã‹æ–°è¦æ€§ã‚’å‡ºã—ãŸã„ã€‚

# ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã¡ã‚ƒã‚“ã¨æ›¸ã„ã¦ã¿ã‚ˆã†

build.zigã‚’ã¡ã‚ƒã‚“ã¨æ›¸ãã¨ã€`zig build` ã ã‘ã§ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

è©¦ã—ã«æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚

```zig
const std = @import("std");

pub fn build(b: *std.Build) void {
    const target = b.standardTargetOptions(.{ .default_target = .{ .cpu_arch = .wasm32, .os_tag = .freestanding } });
    const optimize = b.standardOptimizeOption(.{ .preferred_optimize_mode = .Debug });

    const exe = b.addExecutable(.{
        .name = "zig-wasm-sample",
        .root_source_file = b.path("src/root.zig"),
        .target = target,
        .optimize = optimize,
    });

    b.installArtifact(exe);
}
```

targetã¯æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸãŒã€`-fno-entry -rdynamic --import-memory`ã‚ãŸã‚Šã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã¯ã§ããªã„æ¨¡æ§˜ã€‚

Zigã¯Zigè¨€èªãã®ã‚‚ã®ã§ä½œã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€VSCodeã§ã‚ã‚Œã°F12ã‚­ãƒ¼ã‚’æŠ¼ã›ã°å®šç¾©ã«ã‚¸ãƒ£ãƒ³ãƒ—ã§ãã¾ã™ã€‚

[ExecutableOptions](https://github.com/ziglang/zig/blob/0.13.0/lib/std/Build.zig#L638)ã‚„ã€[addExecutable](https://github.com/ziglang/zig/blob/0.13.0/lib/std/Build.zig#L669)ã®å®šç¾©ã‚’è¦‹ã‚‹ã¨ã€ã©ã‚“ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã§ãã‚‹ã‹ãŒã‚ã‹ã‚Šã¾ã™ã€‚

[src/main.zig](https://github.com/ziglang/zig/blob/0.13.0/src/main.zig#L262)ã§ã€zigã‚³ãƒãƒ³ãƒ‰ã«æ¸¡ã™ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã®åˆ†å²ãŒã‚ã‚Šã¾ã—ãŸã€‚

buildã¨build-exeã§ã¯ã ã„ã¶é›°å›²æ°—ã¡ãŒã†ãªã€‚ã€‚ã€‚

# ãã‚‰ã„ã§

ã™ã¿ã¾ã›ã‚“ã€æ™‚é–“åˆ‡ã‚Œã£ã½ã„ã§ã™ã€‚ã€‚ã€‚

Zigã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã«å‹•ä½œãŒã‚ˆãå¤‰ã‚ã‚‹ä¸€æ–¹ã€ã‚½ãƒ¼ã‚¹ã‚’è¿½ã„ã‹ã‘ã‚„ã™ã„ã®ã§ã€Zigè‡ªä½“ãŒã©ã†å‹•ãã®ã‹ã‚’æŠŠæ¡ã—ã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚

ã¿ãªã•ã‚“ã‚‚ã‚‚ã£ã¨Zigã‚’ä½¿ã£ã¦æµè¡Œã‚‰ã›ã¾ã›ã‚“ã‹ï¼Ÿ
